variables:
    TZ: "America/New_York"
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    APT_CACHE_DIR: "$CI_PROJECT_DIR/apt-cache"
    POSTGRES_DB: custom_db
    POSTGRES_USER: custom_user
    POSTGRES_PASSWORD: custom_pass
    FARADAY_USER: custom_user
    FARADAY_PASSWORD: custom_pass
    FARADAY_EMAIL: test@test.com
    FARADAY_REF: white/dev
    EXECUTOR_DIR: ./basic_executor.py

cache:
  paths:
    - "$CI_PROJECT_DIR/.cache/pip"
    - "$CI_PROJECT_DIR/apt-cache"


before_script:
    - mkdir -pv $APT_CACHE_DIR

stages:
    - testing
    - post_testing

services:
    - postgres:latest

unit_tests:
    image: python:3
    stage: testing
    coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
    script:
        - pip install virtualenv
        - virtualenv faraday_venv
        - source faraday_venv/bin/activate
        - pip install pytest pytest-cov pytest-aiohttp
        - pip install -r requirements_dev.txt
        - python setup.py install
        - mkdir run_from
        - cp tests/data/basic_executor.py ./run_from
        - cd run_from && pytest ../tests/unittests --capture=sys -v --cov=../faraday_agent_dispatcher --color=yes --disable-warnings
    artifacts:
        when: on_failure
        paths:
            - dist/*
    except:
      variables:
        - $INTEGRATION
        - $CI_COMMIT_REF_NAME =~ /^.*ci.*$/

integration_faraday:
    image: python:3
    stage: post_testing
    script:
        - apt-get update && apt-get install
        - apt-get install libsasl2-dev python libldap2-dev libssl-dev
        - pip install virtualenv
        - virtualenv faraday_venv
        - source faraday_venv/bin/activate
        - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/faradaysec/faraday.git
        - cd faraday && git checkout $FARADAY_REF && python3 setup.py install
        - mkdir -p ~/.faraday/config
        - mkdir -p ~/.faraday/doc
        - mkdir -p ~/.faraday/logs
        - echo "${FARADAY_LICENSE_TAR_GZ}" | base64 -d | tar -C ~/.faraday/doc -xvzf -
        - cp tests/data/server.ini ~/.faraday/config
        - python3 ../tests/config/psql_config.py
        - faraday-manage create-tables
        - faraday-manage create-superuser --username $FARADAY_USER --password $FARADAY_PASSWORD --email $FARADAY_EMAIL
        - faraday-server &
        - deactivate
        - cd ..
        - virtualenv faraday_disp_venv
        - source faraday_disp_venv/bin/activate
        - pip install pytest pytest-cov
        - pip install -r requirements_dev.txt
        - python setup.py install
        - mkdir run_from
        - cp tests/data/basic_executor.py ./run_from
        - cd run_from && mkdir logs && pytest ../tests/integration --capture=sys -v --color=yes --disable-warnings --cov=../faraday_agent_dispatcher
    after_script:
        - cp ~/.faraday/logs/*.log run_from/logs/
    artifacts:
        when: always
        paths:
            - run_from/logs/*
        expire_in: 7 days
